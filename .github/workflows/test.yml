name: Backend Tests

# Run pytest on every pull request targeting main, and on direct pushes to main.
on:
  pull_request:
    branches: [main]
    paths:
      - "v1-mvp/backend/**"
      - ".github/workflows/test.yml"
  push:
    branches: [main]
    paths:
      - "v1-mvp/backend/**"
      - ".github/workflows/test.yml"

jobs:
  test:
    name: pytest (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11"]

    defaults:
      run:
        working-directory: v1-mvp/backend

    steps:
      # -----------------------------------------------------------------------
      # 1. Check out source
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2. Set up Python
      # -----------------------------------------------------------------------
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: v1-mvp/backend/requirements.txt

      # -----------------------------------------------------------------------
      # 3. Install dependencies
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # pytest-env is needed for [pytest:env] ENVIRONMENT=test in pytest.ini
          pip install pytest-env

      # -----------------------------------------------------------------------
      # 4. Write .env.test from GitHub secrets
      #    All secrets must be added to the repo under Settings â†’ Secrets.
      # -----------------------------------------------------------------------
      - name: Write .env.test
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          SECRET_KEY: ${{ secrets.TEST_SECRET_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > .env.test << EOF
          DATABASE_URL=${DATABASE_URL}
          DATABASE_SCHEMA=v1_mvp
          SECRET_KEY=${SECRET_KEY}
          GEMINI_API_KEY=${GEMINI_API_KEY}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          API_BASE_URL=http://localhost:8000
          FRONTEND_URL=http://localhost:3000
          DEBUG=True
          ENVIRONMENT=test
          REDIS_URL=
          SQS_ENABLED=False
          STRIPE_SECRET_KEY=sk_test_placeholder
          ADMIN_ALERT_EMAIL=test@test.com
          EOF

      # -----------------------------------------------------------------------
      # 5. Run tests
      #    - tests/ directory: the canonical integration test suite
      #    - Use --tb=short for readable CI output
      #    - Exit non-zero on failure (blocks PR merge)
      # -----------------------------------------------------------------------
      - name: Run pytest
        run: |
          pytest tests/ \
            --tb=short \
            -v \
            --asyncio-mode=strict \
            -x
        env:
          ENVIRONMENT: test

      # -----------------------------------------------------------------------
      # 6. Upload test results (always, so failures are visible in GitHub UI)
      # -----------------------------------------------------------------------
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results-${{ matrix.python-version }}
          path: v1-mvp/backend/.pytest_cache/
          retention-days: 7
